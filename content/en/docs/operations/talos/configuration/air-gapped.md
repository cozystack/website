---
title: Air-Gapped Installation of Talos Linux Cluster
linkTitle: Air-Gap Installation
description: "Bootstrap a Talos Linux cluster for Cozystack with an air-gapped environment"
weight: 20
---

This guide outlines the steps to bootstrap a Cozystack cluster in an **air-gapped environment**.

**Air-gapped** installation means that the cluster has no direct access to the Internet.
All necessary resources, such as images and metadata, must be available on the private network.

---
## Configure nodes
{{% alert color="warning" %}}
For Talm installation, make these changes in `./templates/_helpers.tpl` before making the template.
{{% /alert %}}

### Configure NTP Servers

Accurate time synchronization is critical for the cluster. In your Talos machine configuration, set **local NTP servers** that are accessible inside your private network.

```yaml
machine:
  time:
    servers:
      - 192.168.0.4
      - 10.10.0.5
```
Ensure the specified NTP servers are reachable from first node.

### Configure Container Registry Mirrors
Since the cluster cannot access public container registries, it needs to use their local mirrors.
Creating such mirrors is out of the scope of this guide.

Update your machine configuration in the following way:
```yaml
machine:
  registries:
    mirrors:
      docker.io:
        endpoints:
          - http://10.0.0.1:8082
      ghcr.io:
        endpoints:
          - http://10.0.0.1:8083
      gcr.io:
        endpoints:
          - http://10.0.0.1:8084
      registry.k8s.io:
        endpoints:
          - http://10.0.0.1:8085
      quay.io:
        endpoints:
          - http://10.0.0.1:8086
      cr.fluentbit.io:
        endpoints:
          - http://10.0.0.1:8087
      docker-registry3.mariadb.com:
        endpoints:
          - http://10.0.0.1:8088
    config:
      "10.0.0.1:8082":
        insecure: true
        auth:
          username: myuser
          password: mypass
```
Here, the values for `config.[0].insecure` and `config.[0].auth` are given as examples.
Put the real values instead.
Make sure your local registry proxies mirror all required images for Talos and Kubernetes components.

### Add a CA certificate to the nodes
To use a private Certificate Authority, you need to add its certificate to the nodes.

```yaml
# talm: nodes=["10.10.10.10"], endpoints=["10.10.10.10"], templates=["templates/controlplane.yaml"]
# THIS FILE IS AUTOGENERATED. PREFER TEMPLATE EDITS OVER MANUAL ONES.
machine:
...
...
...
...
  discovery:
    enabled: false
  etcd:
    advertisedSubnets:
      - 10.4.100.10/24
  allowSchedulingOnControlPlanes: true
---
apiVersion: v1alpha1
kind: TrustedRootsConfig
name: my-enterprise-ca
certificates: |
  -----BEGIN CERTIFICATE-----
  ...
  -----END CERTIFICATE-----
```
Make apply for every node
```bash
talm apply -f nodes/srv1
```

### Make sure you have cozystack version 0.31.2 or higher
It necessary for 
```bash
kubectl get deploy -n cozy-system cozystack -oyaml | grep image
```

### Configure Container Registry Mirrors for clients clusters
Create secret:
```yaml
apiVersion: v1
kind: Secret
metadata:
  name: patch-containerd
  namespace: cozy-system
type: Opaque
stringData:
  docker.io.toml: |
    server = "https://registry-1.docker.io"
    [host."http://10.0.0.1:8082"]
      capabilities = ["pull", "resolve"]
      skip_verify = true
  ghcr.io.toml: |
    server = "https://ghcr.io"
    [host."http://10.0.0.1:8083"]
      capabilities = ["pull", "resolve"]
      skip_verify = true
  gcr.io.toml: |
    server = "https://gcr.io"
    [host."http://10.0.0.1:8084"]
      capabilities = ["pull", "resolve"]
      skip_verify = true
  registry.k8s.io.toml: |
    server = "https://registry.k8s.io"
    [host."http://10.0.0.1:8085"]
      capabilities = ["pull", "resolve"]
      skip_verify = true
  quay.io.toml: |
    server = "https://quay.io"
    [host."http://10.0.0.1:8086"]
      capabilities = ["pull", "resolve"]
      skip_verify = true
  cr.fluentbit.io.toml: |
    server = "https://cr.fluentbit.io"
    [host."http://10.0.0.1:8087"]
      capabilities = ["pull", "resolve"]
      skip_verify = true
  docker-registry3.mariadb.com: |
    server = "https://docker-registry3.mariadb.com"
    [host."http://10.0.0.1:8089"]
      capabilities = ["pull", "resolve"]
      skip_verify = true
```
[See more](https://github.com/containerd/containerd/blob/main/docs/cri/config.md#registry-configuration)

this secret will be copied for every client k8s cluster.
If You need set custom config for some cluster, set `useCustomSecretForPatchContainerd: true` in values of kubernetes app since version 0.23.0 and create Secret with name: `kubernetes-clustername` before creating cluster.
